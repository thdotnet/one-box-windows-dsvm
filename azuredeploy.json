{
   "$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{
      "location":{
         "type":"string"
      },
      "networkInterfaceName":{
         "type":"string"
      },
      "networkSecurityGroupName":{
         "type":"string"
      },
      "networkSecurityGroupRules":{
         "type":"array"
      },
      "subnetName":{
         "type":"string"
      },
      "virtualNetworkId":{
         "type":"string"
      },
      "virtualMachineName":{
         "type":"string"
      },
      "virtualMachineRG":{
         "type":"string"
      },
      "osDiskType":{
         "type":"string"
      },
      "virtualMachineSize":{
         "type":"string",
         "defaultValue":"Standard_D3_v2",
         "allowedValues":[
            "Standard_D2_v2",
            "Standard_D3_v2",
            "Standard_D4_v2",
            "Standard_D5_v2",
            "Standard_D11_v2",
            "Standard_D12_v2",
            "Standard_D13_v2",
            "Standard_D14_v2",
            "Standard_D15_v2",
            "Standard_D2",
            "Standard_D3",
            "Standard_D4",
            "Standard_D11",
            "Standard_D12",
            "Standard_D13",
            "Standard_D14",
            "Standard_DS1",
            "Standard_DS2",
            "Standard_DS3",
            "Standard_DS4",
            "Standard_DS11",
            "Standard_DS12",
            "Standard_DS13",
            "Standard_DS14",
            "Standard_DS2_v2",
            "Standard_DS3_v2",
            "Standard_DS4_v2",
            "Standard_DS5_v2",
            "Standard_DS11_v2",
            "Standard_DS12_v2",
            "Standard_DS13_v2",
            "Standard_DS14_v2",
            "Standard_DS15_v2"
         ],
         "metadata":{
            "description":"Size of VM"
         }
      },
      "adminUsername":{
         "type":"string"
      },
      "adminPassword":{
         "type":"secureString"
      },
      "diagnosticsStorageAccountName":{
         "type":"string"
      },
      "diagnosticsStorageAccountId":{
         "type":"string"
      },
      "diagnosticsStorageAccountType":{
         "type":"string"
      },
      "diagnosticsStorageAccountKind":{
         "type":"string"
      },
      "zone":{
         "type":"string"
      },
      "loadBalancerId":{
         "type":"string"
      },
      "backendPoolId":{
         "type":"string"
      },
      "backendPoolName":{
         "type":"string"
      },
      "loadBalancerRG":{
         "type":"string"
      }
   },
   "variables":{
      "nsgId":"[resourceId(resourceGroup().name, 'Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]",
      "vnetId":"[parameters('virtualNetworkId')]",
      "subnetRef":"[concat(variables('vnetId'), '/subnets/', parameters('subnetName'))]",
      "scriptsUri":"[uri(deployment().properties.templateLink.uri, '.')]"
   },
   "resources":[
      {
         "name":"[parameters('networkInterfaceName')]",
         "type":"Microsoft.Network/networkInterfaces",
         "apiVersion":"2018-08-01",
         "location":"[parameters('location')]",
         "dependsOn":[
            "[concat('Microsoft.Network/networkSecurityGroups/', parameters('networkSecurityGroupName'))]",
            "[concat('Microsoft.Resources/deployments/', 'AddLBBackendPool-azr-lb-cor-ml-n-20190201182606')]"
         ],
         "properties":{
            "ipConfigurations":[
               {
                  "name":"ipconfig1",
                  "properties":{
                     "subnet":{
                        "id":"[variables('subnetRef')]"
                     },
                     "privateIPAllocationMethod":"Dynamic",
                     "loadBalancerBackendAddressPools":[
                        {
                           "id":"[parameters('backendPoolId')]"
                        }
                     ]
                  }
               }
            ],
            "networkSecurityGroup":{
               "id":"[variables('nsgId')]"
            }
         },
         "tags":{

         }
      },
      {
         "name":"[parameters('networkSecurityGroupName')]",
         "type":"Microsoft.Network/networkSecurityGroups",
         "apiVersion":"2018-08-01",
         "location":"[parameters('location')]",
         "properties":{
            "securityRules":"[parameters('networkSecurityGroupRules')]"
         },
         "tags":{

         }
      },
      {
         "name":"[parameters('virtualMachineName')]",
         "type":"Microsoft.Compute/virtualMachines",
         "apiVersion":"[providers('Microsoft.Compute','virtualMachines').apiVersions[0]]",
         "location":"[parameters('location')]",
         "dependsOn":[
            "[concat('Microsoft.Network/networkInterfaces/', parameters('networkInterfaceName'))]",
            "[concat('Microsoft.Storage/storageAccounts/', parameters('diagnosticsStorageAccountName'))]"
         ],
         "plan":{
            "name":"[variables('virtualMachineSize')]",
            "publisher":"[variables('imagePublisher')]",
            "product":"[variables('imageOffer')]"
         },
         "properties":{
            "hardwareProfile":{
               "vmSize":"[parameters('virtualMachineSize')]"
            },
            "storageProfile":{
               "osDisk":{
                  "createOption":"fromImage",
                  "managedDisk":{
                     "storageAccountType":"[parameters('osDiskType')]"
                  }
               },
               "imageReference":{
                  "publisher":"MicrosoftRServer",
                  "offer":"MLServer-WS2016",
                  "sku":"Enterprise",
                  "version":"latest"
               }
            },
            "networkProfile":{
               "networkInterfaces":[
                  {
                     "id":"[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                  }
               ]
            },
            "osProfile":{
               "computerName":"[parameters('virtualMachineName')]",
               "adminUsername":"[parameters('adminUsername')]",
               "adminPassword":"[parameters('adminPassword')]",
               "windowsConfiguration":{
                  "enableAutomaticUpdates":true,
                  "provisionVmAgent":true
               }
            },
            "licenseType":"Windows_Server",
            "diagnosticsProfile":{
               "bootDiagnostics":{
                  "enabled":true,
                  "storageUri":"[concat('https://', parameters('diagnosticsStorageAccountName'), '.blob.core.windows.net/')]"
               }
            }
         },
         "resources":[
            {
               "type":"extensions",
               "name":"CustomScriptExtension",
               "apiVersion":"[providers('Microsoft.Compute','virtualMachines/extensions').apiVersions[0]]",
               "location":"[resourceGroup().location]",
               "dependsOn":[
                  "[resourceId('Microsoft.Compute/virtualMachines/', variables('vmName'))]"
               ],
               "properties":{
                  "publisher":"Microsoft.Compute",
                  "type":"CustomScriptExtension",
                  "typeHandlerVersion":"1.8",
                  "autoUpgradeMinorVersion":true,
                  "settings":{
                     "fileUris":[
                        "[concat(variables('scriptsUri'), 'ConfigureOnebox.ps1')]",
                        "[concat(variables('scriptsUri'), 'RunConfigureOnebox.ps1')]"
                     ],
                     "commandToExecute":"[concat('powershell -ExecutionPolicy Unrestricted -File ./RunConfigureOnebox.ps1 -script \"ConfigureOnebox.ps1\" -username \"', parameters('adminUserName'), '\" -password \"', parameters('adminPassword'), '\"')]"
                  }
               }
            }
         ],
         "tags":{

         },
         "zones":[
            "[parameters('zone')]"
         ]
      },
      {
         "name":"[parameters('diagnosticsStorageAccountName')]",
         "type":"Microsoft.Storage/storageAccounts",
         "apiVersion":"2018-07-01",
         "location":"[parameters('location')]",
         "properties":{

         },
         "kind":"[parameters('diagnosticsStorageAccountKind')]",
         "sku":{
            "name":"[parameters('diagnosticsStorageAccountType')]"
         },
         "tags":{

         }
      },
      {
         "apiVersion":"2017-05-10",
         "type":"Microsoft.Resources/deployments",
         "name":"AddLBBackendPool-azr-lb-cor-ml-n-20190201182606",
         "resourceGroup":"[parameters('loadBalancerRG')]",
         "properties":{
            "mode":"Incremental",
            "parameters":{

            },
            "template":{
               "$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
               "contentVersion":"1.0.0.0",
               "parameters":{

               },
               "variables":{

               },
               "resources":[
                  {
                     "name":"azr-lb-cor-ml-n",
                     "id":"/subscriptions/a3c12ec2-455f-4c03-8454-b049ccea67e9/resourceGroups/azr-rg-cor-ml-n/providers/Microsoft.Network/loadBalancers/azr-lb-cor-ml-n",
                     "type":"Microsoft.Network/loadBalancers",
                     "location":"eastus2",
                     "properties":{
                        "provisioningState":"Succeeded",
                        "resourceGuid":"2e9d5031-524d-49f5-bd6b-c07bbc87518b",
                        "frontendIPConfigurations":[
                           {
                              "name":"LoadBalancerFrontEnd",
                              "id":"/subscriptions/a3c12ec2-455f-4c03-8454-b049ccea67e9/resourceGroups/azr-rg-cor-ml-n/providers/Microsoft.Network/loadBalancers/azr-lb-cor-ml-n/frontendIPConfigurations/LoadBalancerFrontEnd",
                              "etag":"W/\"ad31eb4f-50ce-4851-88a8-52bc8b7aa8b0\"",
                              "type":"Microsoft.Network/loadBalancers/frontendIPConfigurations",
                              "properties":{
                                 "provisioningState":"Succeeded",
                                 "privateIPAddress":"10.144.1.11",
                                 "privateIPAllocationMethod":"Static",
                                 "subnet":{
                                    "id":"/subscriptions/a3c12ec2-455f-4c03-8454-b049ccea67e9/resourceGroups/azr-rg-cor-ml-n/providers/Microsoft.Network/virtualNetworks/azr-vn-cor-ml-n/subnets/azr-sn-cor-ml-vms-n"
                                 }
                              }
                           }
                        ],
                        "backendAddressPools":[
                           {
                              "id":"[parameters('backendPoolId')]",
                              "name":"[parameters('backendPoolName')]",
                              "properties":{

                              }
                           }
                        ],
                        "loadBalancingRules":[

                        ],
                        "probes":[

                        ],
                        "inboundNatRules":[

                        ],
                        "outboundRules":[

                        ],
                        "inboundNatPools":[

                        ]
                     },
                     "sku":{
                        "name":"Standard",
                        "tier":"Regional"
                     },
                     "apiVersion":"2018-08-01"
                  }
               ],
               "outputs":{

               }
            }
         }
      }
   ],
   "outputs":{
      "adminUsername":{
         "type":"string",
         "value":"[parameters('adminUsername')]"
      }
   }
}
